apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: deploy
  labels:
    app.kubernetes.io/version: "1.0"
  annotations:
    tekton.dev/displayName: "OpenShift Deploy Task"
    tekton.dev/pipelines.minVersion: "0.17.0"
spec:
  description: >-
    This task deploys the application to OpenShift
  params:
    - name: IMAGE
      description: The image to deploy
      type: string
    - name: APP_NAME
      description: The name of the application
      type: string
      default: "cicd-final-project"
    - name: NAMESPACE
      description: The namespace to deploy to
      type: string
      default: ""
  steps:
    - name: deploy
      image: quay.io/openshift/origin-cli:latest
      script: |
        #!/bin/bash
        set -e
        
        echo "Deploying application $(params.APP_NAME)..."
        
        # Check if deployment exists
        if oc get deployment $(params.APP_NAME) -n $(params.NAMESPACE) > /dev/null 2>&1; then
          echo "Updating existing deployment..."
          oc set image deployment/$(params.APP_NAME) \
            $(params.APP_NAME)=$(params.IMAGE) \
            -n $(params.NAMESPACE)
        else
          echo "Creating new deployment..."
          oc create deployment $(params.APP_NAME) \
            --image=$(params.IMAGE) \
            -n $(params.NAMESPACE)
        fi
        
        # Wait for rollout
        echo "Waiting for rollout to complete..."
        oc rollout status deployment/$(params.APP_NAME) -n $(params.NAMESPACE)
        
        # Expose service if not exists
        if ! oc get service $(params.APP_NAME) -n $(params.NAMESPACE) > /dev/null 2>&1; then
          echo "Creating service..."
          oc expose deployment $(params.APP_NAME) \
            --port=8080 \
            --target-port=8080 \
            -n $(params.NAMESPACE)
        fi
        
        # Expose route if not exists
        if ! oc get route $(params.APP_NAME) -n $(params.NAMESPACE) > /dev/null 2>&1; then
          echo "Creating route..."
          oc expose service $(params.APP_NAME) -n $(params.NAMESPACE)
        fi
        
        echo "Deployment completed successfully!"
        echo "Application URL:"
        oc get route $(params.APP_NAME) -n $(params.NAMESPACE) -o jsonpath='{.spec.host}'

